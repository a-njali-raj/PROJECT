{% extends "layout/base.html" %}
{% load static %}

{% block extra_css %}
<style>
  body {
    font-family: Arial, sans-serif;
    background-image: url('{% static "assets/img/bg_image_2.jpg" %}');
    /* Replace with the actual path to your background image */
    background-size: cover;
    /* This will cover the entire viewport */
    background-repeat: no-repeat;
    background-attachment: fixed;
    /* This will keep the background fixed while scrolling */
  }

  header {
    background-color: #fff;
    /* Set the background color to white */
  }

  /* CSS for the form container */
  .form-container {
    max-width: 600px;
    /* Adjust the width as needed */
    margin: 0 auto;
    /* Center the container horizontally */
    padding: 20px;
    /* Add padding to the container */
    border: 1px solid #ccc;
    /* Add a border around the container */
    border-radius: 5px;
    /* Add rounded corners to the container */
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    /* Add a subtle box shadow */
    background-color: #f9f9f9;
    /* Set the background color */
  }

  /* Apply styles to form elements within the container */
  .form-container input[type="text"],
  .form-container input[type="number"],
  .form-container input[type="date"],
  .form-container input[type="button"],
  .form-container select,
  .form-container textarea,
  .form-container label {
    width: 100%;
    margin-bottom: 10px;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 3px;
    font-size: 16px;
  }

  /* Style checkboxes and radio buttons */
  .form-container input[type="checkbox"],
  .form-container input[type="radio"] {
    margin-right: 5px;
  }

  /* Style the submit button */
  .form-container input[type="submit"] {
    background-color: #007BFF;
    color: #fff;
    border: none;
    border-radius: 3px;
    padding: 10px 20px;
    cursor: pointer;
    font-size: 18px;
    transition: background-color 0.3s;
  }

  .form-container input[type="submit"]:hover {
    background-color: #0056b3;
  }

  .additional-test-container {
    display: none;
    margin-top: 10px;
  }

  .additional-test-container label {
    display: block;
  }

  .additional-test-container select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 3px;
    font-size: 16px;
  }

  .radio-box {
    display: flex;
    align-items: center;
  }

  .radio-label {
    margin-right: 10px;
  }

  .new-address-fields.visible {
    display: block;
  }

  .new-address-fields .form-group {
    margin-right: 20px;
  }
  .error-message {
  color: red;
}
</style>
{% endblock %}

{% block content %}
<div class="form-container">
  <!-- Your form content goes here -->
  <form method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="frminput">


      <h3>
        <center><b><span style="color: rgb(146, 197, 236);">Book Now!</span></b></center>
      </h3> <br><br>
      <select name="test" id="testname" required>
        {% for test in tests %}
        <option value="{{ test.id }}" {% if request.GET.test == test.name %}selected{% endif %}>
          {{ test.name }}
        </option>
        {% endfor %}
      </select>
      <div>
        <label for="prescription" style="display: inline-block; margin-right: 10px;">Upload Prescription (PDF or Image):</label>
        <input type="file" id="prescription" name="prescription" accept=".pdf, .jpg, .jpeg, .png" style="display: inline-block;" />
      </div><br>
      <p>Preferred Date: <input type="date" id="preferred-date" name="date" value="2023-09-29"></p>
      <p>Preferred Time:
        <select id="preferred-time" name="preferred-time">
        </select>
      </p>

      

      <div class="person-fields">
        <div>
          <input type="text" id="full_name" name="full_name" placeholder="Full name" required>
          <span id="full_name_error" class="error-message"></span>
          <select id="gender" name="gender" required>
            <option value="" selected>Select Gender</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
          </select>
          <input type="number" id="age" name="age" placeholder="Age" required>
        </div>
      </div>

      <input type="text" id="email" name="email" placeholder="Email" required readonly value="{{user.email}}">
      <span id="email_error" class="error-message"></span>
      <input type="text" id="phone" name="phone" placeholder="Mobile" required readonly value="{{user.phone_number}}">
      <span id="phone_error" class="error-message"></span>

      <div class="radio-box">
  <label class="radio-label">
    <input type="radio" id="current-address-choice" name="address-choice" value="current-address" checked>
    Use Current Address
  </label>
  <label class="radio-label">
    <input type="radio" id="new-address-choice" name="address-choice" value="new-address">
    Enter New Address
  </label>
</div>

<div id="current-address-fields">
  <!-- Fields for the current address -->
  <input type="text" id="current-home-address" name="current-home-address" placeholder="Current Home Address" readonly value="{{user.address.street_address}}">
  <input type="text" id="current-city" name="current-city" placeholder="Current City" readonly value="{{user.address.city}}">
  <input type="text" id="current-pincode" name="current-pincode" placeholder="Current Pincode" readonly value="{{user.address.pincode}}">
</div>

<div id="new-address-fields" class="new-address-fields" style="display: none;">
  <!-- Fields for the new address -->
  <input type="text" id="new-home-address" name="new-home-address" placeholder="New Home Address">
  <input type="text" id="new-city" name="new-city" placeholder="New City">
  <input type="text" id="new-pincode" name="new-pincode" placeholder="New Pincode">
</div>
</div>
      <!-- Additional tests checkboxes -->

      <label class="agreecheck">
        <input type="checkbox" id="additionalTestsCheckbox" name="additional_tests"
          onclick="toggleAdditionalTestDropdown();">
        <span>Add Additional Tests</span>
      </label>

      <!-- Additional test dropdown container -->
      <div class="additional-test-container" id="additionalTestContainer">

        <select id="additionalTestsSelect" name="additional_tests_select">
          <option value="" selected>Select Test</option>
          {% for test in tests %}
          <option data-price="{{ test.price }}" value="{{ test.id }}">{{ test.name }}</option>
          {% endfor %}
        </select>
      </div>
      <br>

      <span>Choose mode of sample collection :</span><br><br>
      <div>
        <label style="display: inline;">
          <input type="radio" id="homeAppointment" name="appointmentType" value="Home" checked> Home
        </label>
        <label style="display: inline;">
          <input type="radio" id="labAppointment" name="appointmentType" value="Lab"> Lab
        </label>
      </div>

      <select name="location" id="location" class="mt-3" required>
        {% for location in locations %}
        <option data-price="{{ location.amount }}" value="{{ location.id }}">
          {{ location.name }}
        </option>
        {% endfor %}
      </select>

      <input type="number" hidden name="amount" id="total-amount" value="0.0">

  </form>



  <br>

  <!-- Total amount calculation -->
  <div>
    <label style="padding-bottom: 8px; display:block;">
      <span id="totalamnt"><strong>Test price: <span id="tprice"> Rs. </span></strong></span>
    </label>
    
    <label id="hccrglbl">
      <span id="totalamnt"><strong>Home Collection Charge: <span id="hcprice">Rs. 0</span></strong></span>
    </label>

    <label>
      <span id="totalamnt"><strong>Total Amount: <span id="totalprice"> Rs.</span></strong></span>
    </label>
  </div>


  <br>
  <input type="hidden" id="coupontextbox" name="coupontextbox" value="">
  <input type="hidden" id="product_id" name="product_id" value="77">
  <input type="hidden" id="price" name="price" value="300">
  <input type="hidden" name="currenturl" value="https://www.diagnosticcentres.in/health-checkup-packages/cbc-hemogram">
  <input id="frmsubbtn" type="submit" class="frmsub" value="Book Now">
  <input type="hidden" name="sunday" id="sunday" value="">
</div>
</form>
</div>
</div>
{% endblock %}
{% block extra_js %}
<script>
  
  function toggleAdditionalTestDropdown() {
    const additionalTestsCheckbox = document.getElementById("additionalTestsCheckbox");
    const additionalTestContainer = document.getElementById("additionalTestContainer");

    if (additionalTestsCheckbox.checked) {
      additionalTestContainer.style.display = "block";
    } else {
      additionalTestContainer.style.display = "none";
    }
  }
 
  // Get the select element by its ID
  const selectElement = document.getElementById('preferred-time');

  // Function to add time options to the select field
  function addTimeOptions() {
    // Start time (09:00 AM) in 24-hour format
    let startTime = 9;

    // End time (05:30 PM) in 24-hour format
    const endTime = 17.5; // 05:30 PM is equivalent to 17.5 hours

    // Loop to generate time options
    while (startTime <= endTime) {
      // Convert the current time to a formatted string (hh:mm AM/PM)
      const formattedTime = formatTime(startTime);

      // Create an option element
      const option = document.createElement('option');
      option.value = startTime.toFixed(2).replace(".", ":"); // Use toFixed(2) to ensure two decimal places for half hours
      option.text = formattedTime;

      // Add the option to the select field
      selectElement.appendChild(option);

      // Increment time by 0.5 (30 minutes)
      startTime += 0.5;
    }
  }

  // Function to format time as hh:mm AM/PM
  function formatTime(hours) {
    const hour = Math.floor(hours);
    const minutes = (hours % 1) * 60;
    const ampm = hour >= 12 ? 'PM' : 'AM';
    const formattedHour = hour % 12 === 0 ? 12 : hour % 12; // Convert 0 to 12 for 12:00 AM/PM
    const formattedMinutes = minutes < 10 ? `0${minutes}` : minutes;

    return `${formattedHour}:${formattedMinutes} ${ampm}`;
  }

  // Call the function to add time options
  addTimeOptions();
function toggleAddressFields() {
    const currentAddressChoice = document.getElementById("current-address-choice");
    const newAddressChoice = document.getElementById("new-address-choice");
    const currentAddressFields = document.getElementById("current-address-fields");
    const newAddressFields = document.getElementById("new-address-fields");

    if (currentAddressChoice.checked) {
      currentAddressFields.style.display = "block";
      newAddressFields.style.display = "none";
    } else if (newAddressChoice.checked) {
      currentAddressFields.style.display = "none";
      newAddressFields.style.display = "block";
    } else {
      currentAddressFields.style.display = "none";
      newAddressFields.style.display = "none";
    }
  }

  // Add event listeners to the radio buttons to detect changes
  const currentAddressChoice = document.getElementById("current-address-choice");
  const newAddressChoice = document.getElementById("new-address-choice");

  currentAddressChoice.addEventListener("change", toggleAddressFields);
  newAddressChoice.addEventListener("change", toggleAddressFields);

  // Call the function to set the initial state
  toggleAddressFields();

  // Add an event listener to the radio buttons to detect changes
  const fullNameField = document.getElementById("full_name");
  const fullNameError = document.getElementById("full_name_error");
  fullNameField.addEventListener("input", () => {
  const fullName = fullNameField.value.trim();
  const namePattern = /^[A-Za-z\s]+$/; // Regular expression to allow letters and spaces

  if (!namePattern.test(fullName)) {
    fullNameError.textContent = "Full name must contain only letters and spaces";
    fullNameField.classList.add("invalid");
  } else if (fullName.length < 2) {
    fullNameError.textContent = "Full name must be at least 2 characters";
    fullNameField.classList.add("invalid");
  } else {
    fullNameError.textContent = "";
    fullNameField.classList.remove("invalid");
  }
});
const emailField = document.getElementById("email");
const emailError = document.getElementById("email_error");

emailField.addEventListener("input", () => {
  const email = emailField.value.trim();
  const emailPattern = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;

  if (!emailPattern.test(email)) {
    emailError.textContent = "Please enter a valid email address";
    emailField.classList.add("invalid");
  } else {
    emailError.textContent = "";
    emailField.classList.remove("invalid");
  }
});

const phoneField = document.getElementById("phone");
const phoneError = document.getElementById("phone_error");

phoneField.addEventListener("input", () => {
  const phone = phoneField.value.trim();
  const phonePattern = /^[0-9]{10}$/; // Regular expression to allow only 10 digits

  if (!phonePattern.test(phone)) {
    phoneError.textContent = "Please enter a valid 10-digit phone number";
    phoneField.classList.add("invalid");
  } else {
    phoneError.textContent = "";
    phoneField.classList.remove("invalid");
  }
});


const testDropdown = document.getElementById("testname");
  const testPriceElement = document.getElementById("tprice");
  const homeCollectionChargeElement = document.getElementById("hcprice");
  const totalAmountElement = document.getElementById("totalprice");
  const additionalTestsSelect = document.getElementById("additionalTestsSelect");

  // Function to fetch and update the test price based on the selected test
  function updateTestPrice() {
    const selectedOption = testDropdown.options[testDropdown.selectedIndex];
    const testId = selectedOption.value;

    fetch(`/get_test_price/?test_id=${testId}`) // Replace with your actual URL
      .then(response => response.json())
      .then(data => {
        if (data.price !== null) {
          testPriceElement.textContent = `Rs. ${parseFloat(data.price) || 0}`;
          calculateTotalAmount(); // Recalculate total amount
        } else {
          testPriceElement.textContent = "Price not available";
          totalAmountElement.textContent = "Total Amount: N/A";
        }
      })
      .catch(error => {
        console.error("Error fetching test price:", error);
        testPriceElement.textContent = "Error fetching price";
        totalAmountElement.textContent = "Total Amount: N/A";
      });
  }

  // Function to calculate and update the total amount
  function calculateTotalAmount() {
    const testPrice = parseFloat(testPriceElement.textContent.replace("Rs. ", " ")) || 0;
    const homeCollectionCharge = parseFloat(homeCollectionChargeElement.textContent.replace("Rs. ", " ")) || 0;
    const totalAmountInput = document.getElementById("total-amount");

    // Calculate the total amount including the selected additional tests
    const additionalTestsTotalPrice = Array.from(additionalTestsSelect.selectedOptions)
      .map(option => parseFloat(option.dataset.price) || 0)
      .reduce((acc, price) => acc + price, 0);

    const totalAmount = testPrice + homeCollectionCharge + additionalTestsTotalPrice;

    if (!isNaN(totalAmount)) {
      totalAmountElement.textContent = `Rs. ${totalAmount}`;
      totalAmountInput.value = totalAmount;
    } else {
      totalAmountElement.textContent = "Total Amount: N/A";
    }
  }

  // Add an event listener to the test dropdown to update the test price and total amount
  testDropdown.addEventListener("change", updateTestPrice);

  // Add an event listener to the additional tests dropdown to recalculate total amount on changes
  additionalTestsSelect.addEventListener("change", calculateTotalAmount);

  // Call the updateTestPrice function initially to set the default price
  updateTestPrice();
  const homeAppointment = document.getElementById("homeAppointment");
  const labAppointment = document.getElementById("labAppointment");
  const locationSelect = document.getElementById("location");
  function updateHomeCollectionCharge() {
    const locationSelect = document.getElementById("location");
    const selectedLocationOption = locationSelect.options[locationSelect.selectedIndex];
    const homeCollectionCharge = parseFloat(selectedLocationOption.dataset.price) || 0;
    const homeCollectionChargeElement = document.getElementById("hcprice");
    
    if (!isNaN(homeCollectionCharge)) {
      homeCollectionChargeElement.textContent = ` ${homeCollectionCharge}`;
      calculateTotalAmount(); // Recalculate total amount
    } else {
      homeCollectionChargeElement.textContent = "Home Collection Charge: N/A";
      totalAmountElement.textContent = "Total Amount: N/A";
    }
  }

  // Add an event listener to the location dropdown to update home collection charge
  locationSelect.addEventListener("change", updateHomeCollectionCharge);

  // Call the updateHomeCollectionCharge function initially to set the default home collection charge
  updateHomeCollectionCharge();

  function toggleLocationSelection() {
    if (homeAppointment.checked) {
      locationSelect.style.display = "block";
    } else {
      locationSelect.style.display = "none";
    }
  }

  // Add event listeners to the radio buttons
  homeAppointment.addEventListener("change", toggleLocationSelection);
  labAppointment.addEventListener("change", toggleLocationSelection);

  // Call the function to set the initial state
  toggleLocationSelection();
  const form = document.querySelector('form');
  const submitButton = document.getElementById('frmsubbtn');

  form.addEventListener('submit', function (event) {
    // Prevent the default form submission
    event.preventDefault();

    // You can perform any additional actions here, such as form validation

    // If everything is valid, you can submit the form
    form.submit();
  });

  // Alternatively, you can also handle form submission when the "Book Now" button is clicked
  submitButton.addEventListener('click', function (event) {
    event.preventDefault();
    form.submit();
  });
</script>
{% endblock %}